<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<head>
    <title>rFold reference</title>
    <link rel="stylesheet" href="../ldoc.css" type="text/css" />
</head>
<body>

<div id="container">

<div id="product">
	<div id="product_logo"></div>
	<div id="product_name"><big><b></b></big></div>
	<div id="product_description"></div>
</div> <!-- id="product" -->


<div id="main">


<!-- Menu -->

<div id="navigation">
<br/>
<h1>rFold</h1>

<ul>
  <li><a href="../index.html">Index</a></li>
</ul>



<h2>Examples</h2>
<ul class="$(kind=='Topics' and '' or 'nowrap'">
  <li><strong>buildProtein.lua</strong></li>
</ul>
<h2>Classes</h2>
<ul class="$(kind=='Topics' and '' or 'nowrap'">
  <li><a href="../classes/Protein.html">Protein</a></li>
  <li><a href="../classes/Chain.html">Chain</a></li>
  <li><a href="../classes/Residue.html">Residue</a></li>
  <li><a href="../classes/Dihedron.html">Dihedron</a></li>
  <li><a href="../classes/Hedron.html">Hedron</a></li>
  <li><a href="../classes/geom3d.html">geom3d</a></li>
  <li><a href="../classes/parsers.html">parsers</a></li>
  <li><a href="../classes/utils.html">utils</a></li>
</ul>
<h2>Topics</h2>
<ul class="$(kind=='Topics' and '' or 'nowrap'">
  <li><a href="../topics/README.md.html">README</a></li>
</ul>

</div>

<div id="content">

    <h2>buildProtein.lua</h2>
<pre>
#!/usr/bin/env luajit

<span class="comment">--[[
   buildProtein.lua

Copyright 2016 Robert T. Miller

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use these files except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
]]</span>

<span class="comment">--- buildProtein.lua [ options ] &lt;PDB file | PIC file&gt; ...
</span><span class="comment">--
</span><span class="comment">-- Default action is to read a PDB file and print corresponding 'Protein
</span><span class="comment">-- Internal Coordinates' (PIC) data, or a PIC file and print corresponding
</span><span class="comment">-- PDB format output.
</span><span class="comment">--
</span><span class="comment">-- options:
</span><span class="comment">--
</span><span class="comment">-- -f=&lt;list of PDB codes&gt; : read PDB codes and optional chain IDs
</span><span class="comment">--                            from file and use to form filename to read
</span><span class="comment">--                            from PDB_repository (location specified below),
</span><span class="comment">--                            e.g. 7RSA becomes
</span><span class="comment">--                            /media/data/pdb/rs/pdb7rsa.ent.gz
</span><span class="comment">-- -w : instead of printing, write output to input filename with '.pic'.
</span><span class="comment">--                            or '.gpdb' (generated PDB) extension
</span><span class="comment">-- -t : test mode - read input file, generate PDB data or internal
</span><span class="comment">--                            coordinates, attempt to re-generate input file,
</span><span class="comment">--                            compare to input and report initial differences
</span><span class="comment">--                            if any
</span><span class="comment">--
</span><span class="comment">-- Using the -t and -f option with a cullpdb_pc20_res2.2_R1.0.curr from May, 2016
</span><span class="comment">-- (http://dunbrack.fccc.edu/PISCES.php -- Dunbrack Lab PISCES server),
</span><span class="comment">-- 97.5% of 5,825 protein chains are regenerated correctly (backbone and sidechain
</span><span class="comment">-- atoms) according to the line-by-line comparison test.
</span>


<span class="keyword">local</span> parsers = <span class="global">require</span> <span class="string">'rfold.parsers'</span>
<span class="keyword">local</span> protein = <span class="global">require</span> <span class="string">"rfold.protein"</span>
<span class="keyword">local</span> utils = <span class="global">require</span> <span class="string">'rfold.utils'</span>

<span class="keyword">local</span> PDB_repository_base = <span class="string">'/media/data/pdb/'</span>

<span class="keyword">local</span> args = parsers.parseCmdLine(
   {
<span class="comment">--      ['a'] = 'average: generate hedron_default.lua and dihedron_default.lua files of average values from input files',
</span>      [<span class="string">'t'</span>] = <span class="string">'test: convert (PDB|internal_coordinates) input to (internal_coordinates|PDB) and back again, verify match'</span>,
      [<span class="string">'w'</span>] = <span class="string">'write: converted result to &lt;pdbid&gt;.pdb or &lt;pdbid&gt;.pic in current directory'</span>
   },{
      [<span class="string">'f'</span>] = <span class="string">'&lt;input file&gt; : process files listed in &lt;input file&gt; (1 per line) followed by any on command line'</span>
     },
   <span class="string">'convert PDB files to internal coordinates and vice-versa'</span>
)

<span class="keyword">local</span> toProcess={}
<span class="keyword">if</span> args[<span class="string">'f'</span>] <span class="keyword">then</span>
   <span class="keyword">for</span> i,f <span class="keyword">in</span> <span class="global">ipairs</span>(args[<span class="string">'f'</span>]) <span class="keyword">do</span>
      <span class="keyword">local</span> fh=<span class="global">io</span>.open(f)
      <span class="keyword">for</span> line <span class="keyword">in</span> fh:lines() <span class="keyword">do</span>
         <span class="global">table</span>.insert(toProcess, line)
      <span class="keyword">end</span>
   <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">for</span> i,a <span class="keyword">in</span> <span class="global">ipairs</span>(args) <span class="keyword">do</span> <span class="global">table</span>.insert(toProcess, a) <span class="keyword">end</span>

<span class="keyword">for</span> i,a <span class="keyword">in</span> <span class="global">ipairs</span>(toProcess) <span class="keyword">do</span>
   <span class="keyword">if</span> a:match(<span class="string">'^IDs%s'</span>) <span class="keyword">then</span> toProcess[i]=<span class="string">''</span> <span class="keyword">end</span>
   <span class="keyword">if</span> a:match(<span class="string">'^#'</span>) <span class="keyword">then</span> toProcess[i]=<span class="string">''</span> <span class="keyword">end</span>
   <span class="keyword">if</span> a:ematch(<span class="string">'^(%d%w%w%w)(%w?)%s+'</span>) <span class="keyword">then</span> <span class="comment">-- looks like pdbcode with optional chain, read as compressed file from PDB_repository_base
</span>      <span class="keyword">local</span> pdbid, chn = _1:lower(), _2
      <span class="keyword">local</span> subdir = pdbid:match(<span class="string">'^%w(%w%w)%w$'</span>)
      toProcess[i] = PDB_repository_base .. <span class="string">'/'</span> .. subdir .. <span class="string">'/pdb'</span> .. pdbid:lower() .. <span class="string">'.ent.gz'</span>
      <span class="keyword">if</span> (chn) <span class="keyword">then</span>
         toProcess[i] = toProcess[i] .. <span class="string">' '</span> .. chn
      <span class="keyword">end</span>
   <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">for</span> i,arg <span class="keyword">in</span> <span class="global">ipairs</span>(toProcess) <span class="keyword">do</span>
   <span class="keyword">if</span> <span class="string">''</span> ~= arg <span class="keyword">then</span>
      <span class="comment">--print(arg)
</span>      <span class="keyword">if</span> <span class="string">'quit'</span> == arg <span class="keyword">then</span> <span class="global">os</span>.exit() <span class="keyword">end</span>    <span class="comment">-- so can insert 'quit' in input file of PDB IDs for testing and debugging
</span>      <span class="keyword">local</span> file,chain = arg:match(<span class="string">'^(%S+)%s?(%w?)%s*$'</span>)
      <span class="keyword">if</span> chain == <span class="string">''</span> <span class="keyword">then</span> chain = <span class="keyword">nil</span> <span class="keyword">end</span>
      <span class="comment">--print(file,chain,arg)
</span>      <span class="keyword">local</span> pdbid = parsers.parseProteinData(file, <span class="keyword">function</span> (t) protein.<span class="global">load</span>(t) <span class="keyword">end</span>, chain)
      <span class="keyword">local</span> prot = protein.get(pdbid)

      <span class="keyword">if</span> prot:countDihedra() &gt; <span class="number">0</span> <span class="keyword">then</span>  <span class="comment">-- did read internal coordinates, so generate PDB
</span>
         prot:setStartCoords()               <span class="comment">-- copy residue 1 N, CA, C coordinates from input data to each chain residue 1 initCoords list
</span>         <span class="keyword">if</span> args[<span class="string">'a'</span>] <span class="keyword">then</span>
            <span class="comment">-- not yet implemented
</span>            <span class="comment">--hedron_default = prot:addHedronData(hedron_default)
</span>            <span class="comment">--dihedron_default = prot:addDihedronData(dihedron_default)
</span>         <span class="keyword">elseif</span> args[<span class="string">'t'</span>] <span class="keyword">then</span>
            <span class="global">io</span>.write(<span class="string">'testing '</span> .. arg .. <span class="string">' ... '</span>)
            <span class="global">io</span>.flush()
            <span class="keyword">local</span> s0 = prot:writeInternalCoords()  <span class="comment">-- get output for internal coordinate data as loaded
</span>            prot:internalToAtomCoords()    <span class="comment">-- generate PDB atom coordinates from internal coordinates
</span>            prot:clearInternalCoords()          <span class="comment">-- wipe internal coordinates as loaded
</span>            prot:atomsToInternalCoords()    <span class="comment">-- generate internal coordinates from PDB atom coordinates
</span>            <span class="keyword">local</span> s1 = prot:writeInternalCoords()  <span class="comment">-- get output for internal coordinate data as generated
</span>            <span class="keyword">local</span> c = lineByLine(s0,s1)
            <span class="keyword">if</span> c <span class="keyword">then</span>
               <span class="global">print</span>(<span class="string">'passed. '</span> .. c .. <span class="string">' pic lines compared, '</span> .. prot:report())
            <span class="keyword">else</span>
               <span class="global">print</span>(<span class="string">'failed'</span>)
            <span class="keyword">end</span>
         <span class="keyword">else</span>
            prot:internalToAtomCoords()
            <span class="keyword">local</span> s = prot:writePDB()              <span class="comment">-- get PDB format text
</span>            <span class="keyword">if</span> args[<span class="string">'w'</span>] <span class="keyword">then</span>
               utils.writeFile(pdbid .. <span class="string">'.gpdb'</span>,s)
            <span class="keyword">else</span>
               <span class="global">print</span>(s)
            <span class="keyword">end</span>
         <span class="keyword">end</span>

      <span class="keyword">else</span>                             <span class="comment">-- did read PDB, generate internal coordinates
</span>         prot:setStartCoords()            <span class="comment">-- copy first residue N, CA, C coordinates from input data to each chain residue 1 initCoords list
</span>
         prot:atomsToInternalCoords()          <span class="comment">-- calculate bond lengths, bond angles and dihedral angles from input coordinates
</span>         <span class="keyword">if</span> args[<span class="string">'a'</span>] <span class="keyword">then</span>
            <span class="comment">--hedron_default = prot:addHedronData(hedron_default)
</span>            <span class="comment">--dihedron_default = prot:addDihedronData(dihedron_default)
</span>         <span class="keyword">elseif</span> args[<span class="string">'t'</span>] <span class="keyword">then</span>
            <span class="global">io</span>.write(<span class="string">'testing '</span> .. a .. <span class="string">' ... '</span>)
            <span class="global">io</span>.flush()
            <span class="keyword">local</span> s0 = prot:writePDB(<span class="keyword">true</span>)     <span class="comment">-- PDB format text without REMARK RFOLD record (timestamp may not match)
</span>            prot:clearAtomCoords()
            prot:internalToAtomCoords()
            <span class="keyword">local</span> s1 = prot:writePDB(<span class="keyword">true</span>)
            <span class="keyword">local</span> c = lineByLine(s0,s1)
            <span class="keyword">if</span> c <span class="keyword">then</span>
               <span class="global">print</span>(<span class="string">'passed: '</span> .. c .. <span class="string">' pdb lines compared, '</span> .. prot:report())
            <span class="keyword">else</span>
               <span class="global">print</span>(<span class="string">'failed'</span>)
            <span class="keyword">end</span>
         <span class="keyword">else</span>
            <span class="keyword">local</span> s = prot:writeInternalCoords()
            <span class="keyword">if</span> args[<span class="string">'w'</span>] <span class="keyword">then</span>
               utils.writeFile(pdbid .. <span class="string">'.pic'</span>,s)
            <span class="keyword">else</span>
               <span class="global">print</span>(s)
            <span class="keyword">end</span>
         <span class="keyword">end</span>
      <span class="keyword">end</span>
      protein.drop(pdbid)
   <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">local</span> <span class="keyword">function</span> lineByLine(s1,s2)
   <span class="keyword">local</span> s1t, s2t = {}, {}
   <span class="keyword">for</span> line <span class="keyword">in</span> s1:gmatch(<span class="string">"[^\r\n]+"</span>) <span class="keyword">do</span> s1t[#s1t+<span class="number">1</span>] = line <span class="keyword">end</span>
   <span class="keyword">for</span> line <span class="keyword">in</span> s2:gmatch(<span class="string">"[^\r\n]+"</span>) <span class="keyword">do</span> s2t[#s2t+<span class="number">1</span>] = line <span class="keyword">end</span>

   <span class="keyword">local</span> ecnt = <span class="number">2</span>
   <span class="keyword">for</span> i,lin <span class="keyword">in</span> <span class="global">ipairs</span>(s1t) <span class="keyword">do</span>
      <span class="keyword">if</span> lin ~= s2t[i] <span class="keyword">then</span>
         <span class="global">print</span>()
         <span class="global">print</span>(lin)
         <span class="global">print</span>(s2t[i])
         ecnt = ecnt-<span class="number">1</span>
         <span class="keyword">if</span> <span class="number">0</span>&gt;ecnt <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">false</span> <span class="keyword">end</span>
      <span class="keyword">end</span>
   <span class="keyword">end</span>
   <span class="keyword">if</span> #s1t ~= #s2t <span class="keyword">then</span>
      <span class="global">print</span>(<span class="string">' different linecounts.'</span>)
      <span class="keyword">return</span> <span class="keyword">false</span>
   <span class="keyword">end</span>
   <span class="comment">--return true
</span>   <span class="keyword">return</span> #s1t
<span class="keyword">end</span></pre>


</div> <!-- id="content" -->
</div> <!-- id="main" -->
<div id="about">
<i>generated by <a href="http://github.com/stevedonovan/LDoc">LDoc 1.4.3</a></i>
<i style="float:right;">Last updated 2016-06-10 13:13:37 </i>
</div> <!-- id="about" -->
</div> <!-- id="container" -->
</body>
</html>
